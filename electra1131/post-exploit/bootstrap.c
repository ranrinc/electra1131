//
//  bootstrap.c
//  electra
//
//  Created by Jamie Bishop on 11/02/2018.
//  Copyright Â© 2018 Electra Team. All rights reserved.
//

#include "bootstrap.h"
#include "file_utils.h"
#include "electra_objc.h"
#include "amfi_utils.h"
#include "utils.h"
#include <sys/stat.h>
#include <sys/wait.h>
#include <sys/fcntl.h>
#include <unistd.h>
#include <spawn.h>

#define tar "/electra/tar"

pid_t pd;

void copy_tar() {
    extractGz("tar", "/electra/tar");
    chmod(tar, 0755);
    inject_trusts(1, (const char **)&(const char*[]){tar});
}

void copy_basebinaries() {
    mkdir("/electra", 0755);
    
    printf("copying tar binary...");
    
    copy_tar();
    
    // Remove old base binaries
    unlink("/electra/jailbreakd");
    unlink("/electra/jailbreakd_client");
    unlink("/electra/libjailbreak.dylib");
    
    unlink("/electra/amfid_payload.dylib");
    unlink("/electra/inject_ctriticald");
    unlink("/electra/pspawn_payload.dylib");
    
    unlink("/electra/createSnapshot");
    unlink("/electra/createSystemSnapshot");
    unlink("/electra/helloworld");
    
    extractGz("rm","/electra/rm");
    chmod("/electra/rm", 0755);
    
    printf("Running tar...\n");
    
    posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "-xpf", progname("basebinaries.tar"), "-C", "/electra", NULL }, NULL);
    waitpid(pd, NULL, 0);
    
    printf("[bootstrapper] copied the required binaries into the right places\n");
    
    inject_trusts(4, (const char **)&(const char*[]){
        "/electra/inject_criticald",
        "/electra/amfid_payload.dylib",
        "/electra/pspawn_payload.dylib",
        "/electra/libjailbreak.dylib"
    });
}

void extract_bootstrap() {
    unlink("/bin/launchctl");
    extractGz("launchctl", "/electra/launchctl");
    cp("/bin/launchctl", "/electra/launchctl");
    chmod("/bin/launchctl", 0755);
    unlink("/electra/launchctl");
    
    int bootstrapped = open("/.bootstrapped_electra", O_RDONLY);
    if (bootstrapped != -1) {
        close(bootstrapped);
        return post_bootstrap(false);
    }
    close(bootstrapped);
    
    installingCydia();
    
    extractGz("bootstrap.tar", "/electra/bootstrap.tar");
    
    posix_spawn(&pd, tar, NULL, NULL, (char **)&(const char*[]){ tar, "--preserve-permissions", "-xvkf", "/electra/bootstrap.tar", "-C", "/", NULL }, NULL);
    waitpid(pd, NULL, 0);
    
    unlink("/electra/bootstrap.tar");
    
    FILE *file = fopen("/etc/hosts","w"); /* write file (create a file if it does not exist and if it does treat as empty.*/
    fprintf(file,"%s","##\n"); //writes
    fprintf(file,"%s","# Host Database\n"); //writes
    fprintf(file,"%s","# localhost is used to configure the loopback interface\n"); //writes
    fprintf(file,"%s","# when the system is booting.  Do not change this entry.\n"); //writes
    fprintf(file,"%s","##\n"); //writes
    fprintf(file,"%s","127.0.0.1    localhost\n"); //writes
    fprintf(file,"%s","255.255.255.255 broadcasthost\n"); //writes
    fprintf(file,"%s","::1      localhost\n"); //writes
    fclose(file); /*done!*/
    
    int rv = open("/.bootstrapped_electra", O_RDWR|O_CREAT);
    close(rv);
    rv = open("/.cydia_no_stash",O_RDWR|O_CREAT);
    close(rv);
    
    printf("[bootstrapper] extracted bootstrap to / \n");
    post_bootstrap(true);
}

void post_bootstrap(const bool runUICache) {
    if (runUICache){
        run("/usr/bin/uicache");
    }
    
    unlink(tar);
    
    FILE *file;
    file = fopen("/etc/apt/sources.list.d/electra.list","w"); /* write file (create a file if it does not exist and if it does treat as empty.*/
    fprintf(file,"%s","deb https://electrarepo64.coolstar.org/ ./\n"); //writes
    fprintf(file,"%s","\n"); //writes
    fclose(file);
    
    unlink("/etc/apt/sources.list.d/electra-shim.list");
    
    unlink("/usr/lib/libjailbreak.dylib");
    cp("/usr/lib/libjailbreak.dylib","/electra/libjailbreak.dylib");
    
    inject_trusts(1, (const char **)&(const char*[]){"/bin/launchctl"});
    
    int rv = open("/var/lib/dpkg/available", O_RDWR|O_CREAT);
    close(rv);
    
    run("/usr/libexec/cydia/firmware.sh");
    run("/Library/dpkg/info/openssh.postinst");
    run("launchctl load /Library/LaunchDaemons/com.openssh.sshd.plist");
    
    char *myenviron[] = {
        "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/bin/X11:/usr/games",
        "PS1=\\h:\\w \\u\\$ ",
        NULL
    };
    posix_spawn(&pd, "/usr/bin/dpkg", NULL, NULL, (char **)&(const char*[]){ "dpkg", "-i", "--refuse-downgrade", progname("apt7_1.7.0_iphoneos-arm.deb"),progname("apt7-key_1.7.0_iphoneos-arm.deb"),progname("apt7-lib_1.7.0-sileo_iphoneos-arm.deb"), NULL }, (char **)&myenviron);
    waitpid(pd, NULL, 0);
    posix_spawn(&pd, "/usr/bin/dpkg", NULL, NULL, (char **)&(const char*[]){ "dpkg", "-i", "--refuse-downgrade", progname("cydia-gui_1.1.30-4_iphoneos-arm.deb"),progname("cydia_1.9.1_iphoneos-arm.deb"), NULL}, (char **)&myenviron);
    waitpid(pd, NULL, 0);
    posix_spawn(&pd, "/usr/bin/dpkg", NULL, NULL, (char **)&(const char*[]){ "dpkg", "-i", "--refuse-downgrade", progname("dpkg_1.19.2-4_iphoneos-arm.deb"), NULL }, (char **)&myenviron);
    waitpid(pd, NULL, 0);
    
    printf("[bootstrapper] device has been bootstrapped!\n");
    
    if (runUICache){
        cydiaDone();
    }
}
